.include"m328PBdef.inc"

.def temp=r16
.def freq=r23
.def ADC_H=r21
.def ADC_L=r20

.equ f_CPU = 16		    ; f = 16 MHz

.equ PD0=0 
.equ PD1=1 
.equ PD2=2 
.equ PD3=3 
.equ PD4=4 
.equ PD5=5 
.equ PD6=6 
.equ PD7=7 

.org 0x0
rjmp reset
.org 0x02A
rjmp ISR_ADC

reset:
    ; init stack pointer
    ldi temp, low(RAMEND)
    out SPL, temp
    ldi temp, high(RAMEND)
    out SPH, temp
    
    ; ADC enable, no conversion, ADCIE = 1, prescaler = 128
    ldi temp, 0b10001111
    sts ADCSRA, temp
    
    ; Vref = 5V, ADLAR = 0, ADC1 -> PC1
    ldi temp, 0b01000001
    sts ADMUX, temp
    
    ; Enable Global Interrupts
    sei
    
    ; set PORTC as input
    clr temp
    out DDRC, temp

start_conv:
    lds temp, ADCSRA
    ori temp, (1<<ADSC)
    sts temp, ADCSRA

wait_adc:
    lds temp, ADCSRA
    sbrc temp, ADSC
    rjmp wait_adc
    
    ldi r24, low(1000)
    ldi r25, high(1000)
    rcall wait_ms
    rjmp start_conv


ISR_ADC:
    lds ADC_L, ADCL
    lds ADC_H, ADCH
    reti
    
; delay subroutines
wait_msec:		    ; 1 ms = f_CPU * 1000 cycles
    ldi freq, f_CPU
loop_out:
    ldi r22, 249
loop_inn:
    dec r22
    nop
    brne loop_inn
    dec freq
    brne loop_out
    sbiw r24, 1
    brne wait_msec
    ret

wait_usec:		    ; 1 us = f_CPU cycles
    ldi freq, (f_CPU>>2)
loop:			    ; del_loop = 4 * f_CPU/4 cycles
    nop
    dec freq
    brne loop
    sbiw r24, 1
    brne wait_usec
    ret
